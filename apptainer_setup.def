Bootstrap: docker
From: nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04

%post
    apt update && apt install -y \
        wget \
        git \
        build-essential \
        curl \
        cmake \
        libncurses5-dev \
        zlib1g-dev liblzma-dev libbz2-dev libcurl4-openssl-dev libspdlog-dev libboost-all-dev -y
        
    export CUDA_HOME=/usr/local/cuda-11.8
    export PATH=/usr/local/cuda-11.8/bin:$PATH
    export LD_LIBRARY_PATH=/usr/local/cuda-11.8/lib64:$LD_LIBRARY_PATH

    #  # # conda
    mkdir -p ./miniconda3
    mkdir -p ./miniconda3
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /home/miniconda.sh
    bash /home/miniconda.sh -b -u -p /home/miniconda3
    . /home/miniconda3/bin/activate base
    
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r

    ## HSTlib setup
    wget https://github.com/samtools/htslib/releases/download/1.21/htslib-1.21.tar.bz2
    tar -xjf htslib-1.21.tar.bz2
    cd htslib-1.21
    ./configure --prefix=/usr/local
    make -j && make install

    # # DeepBAM
    . /home/miniconda3/bin/activate
    mkdir /DeepBAM && cd /DeepBAM
    conda create -n DeepBAM python=3.11 -y
    conda activate DeepBAM
    pip install numpy torch==2.0.1
    
    git clone https://github.com/xiaochuanle/DeepBAM.git .
    cd cpp
    mkdir build && cd build 

    export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
    export CMAKE_PREFIX_PATH=`python -c 'import torch;print(torch.utils.cmake_prefix_path)'`
    cmake -DCMAKE_PREFIX_PATH=`python -c 'import torch;print(torch.utils.cmake_prefix_path)'` ..
    make -j

    echo '#!/bin/bash' > /usr/local/bin/DeepBAM
    echo ". /home/miniconda3/bin/activate DeepBAM;" >> /usr/local/bin/DeepBAM
    echo 'export CUDA_HOME="/usr/local/cuda-11.8"' >> /usr/local/bin/DeepBAM
    echo 'export LD_LIBRARY_PATH="/usr/local/cuda-11.8/lib64:$LD_LIBRARY_PATH"' >> /usr/local/bin/DeepBAM
    echo 'export LD_LIBRARY_PATH="/usr/local/lib:$LD_LIBRARY_PATH"' >> /usr/local/bin/DeepBAM
    echo '/DeepBAM/cpp/build/DeepBAM $@;' >> /usr/local/bin/DeepBAM
    chmod +x /usr/local/bin/DeepBAM

    ## DEEPPLANT
    export CUDA_HOME=/usr/local/cuda-11.8
    export PATH=/usr/local/cuda-11.8/bin:$PATH
    export LD_LIBRARY_PATH=/usr/local/cuda-11.8/lib64:$LD_LIBRARY_PATH
    . /home/miniconda3/bin/activate base      

    # # DeepPlant
    mkdir /DeepPlant && cd /DeepPlant
    conda create -n DeepPlant python=3.12 -y
    conda activate DeepPlant
    pip install numpy==1.26 torch==2.2.1
    
    git clone https://github.com/xiaochuanle/DeepPlant.git .
    # cd 3rdparty/htslib
    # tar -xjf htslib-1.21.tar.bz2
    # 
    # cd htslib-1.21
    # ./configure --prefix=/usr/local
    # make -j && make install
    export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH

    # cd ../../..
    
    mkdir build && cd build
    cmake -DCMAKE_PREFIX_PATH=`python -c 'import torch;print(torch.utils.cmake_prefix_path)'` ..
    make -j
    conda deactivate 

    echo '#!/bin/bash' > /usr/local/bin/DeepPlant
    echo ". /home/miniconda3/bin/activate DeepPlant" >> /usr/local/bin/DeepPlant
    echo '/DeepPlant/build/DeepPlant $@' >> /usr/local/bin/DeepPlant
    chmod +x /usr/local/bin/DeepPlant


%environment
    export CUDA_HOME="/usr/local/cuda-11.8"
    export LD_LIBRARY_PATH="/usr/local/cuda-11.8/lib64:$LD_LIBRARY_PATH"
    export LD_LIBRARY_PATH="/usr/local/lib:$LD_LIBRARY_PATH"
    . /home/miniconda3/bin/activate base

