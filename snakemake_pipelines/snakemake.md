# Running the snakemake workflow

## Dependencies

- [Dorado](https://github.com/nanoporetech/dorado)<br/>
- [DeepMod2](https://github.com/WGLab/DeepMod2/tree/main)<br/>
- [DeepBAM](https://github.com/xiaochuanle/DeepBAM)<br/>
- [DeepPlant](https://github.com/xiaochuanle/DeepPlant/tree/main)<br/>
- [f5C](https://github.com/hasindu2008/f5c/tree/master)<br/>
- [Rockfish](https://github.com/lbcb-sci/rockfish/tree/r10.4.1)<br/>

other dependencies can be installed using the [env.yml](/env.yml) included in this repo

```bash
    conda env create -f env.yml -n ont_basemod_benchmarking_env
    conda activate ont_basemod_benchmarking_env
```

## pre-requisites to workflow setup

### Setting up the reference files
The appropriate references files have to be downloaded. The [references.yaml](../references.yaml) contains the mappings to the locations to each references. To include new species you can add your own keys and value pairs.

<b>Note: </b> The keys have to match those of the pod5 samples that are used for basecalling. 
    Eg: 
        pod5 file: pod5/HG002_5kHz
        reference key: HG002

### setting up the config file

#### selecting tools to run and their sorresponding models:
The config file contains the controls to which tools need to be run and where the install directories to each tool resides. This can be modified if you have already installed any of the aforementioned tools.

<pre>
    dorado_mods:
      5mC:  []
      5mCG: [v4r1, v5r1, v5r3, v5.2r2]
      6mA:  []
      4mC:  []
    
    rockfish_run:             []
    deepmod2_transformer_run: [v5r3]
    deepmod2_bilstm_run:      [v5r3]
    f5c_run:                  []
    f5c_stranded_run:         []
    deepbam_run:              []
    deepplnat_run:            []
</pre>

In the current configuration the model names mentioned in the square brackets represents the dorado model that each of the tool will use. Leaving any of the values empty would lead to that specific tool not running.

In this example: 
    only deepmod2_transformer and deepmod2_bilstm would run.
    and for dorado:
        v4r1, v5r1, v5r3, v5.2r2 would be run individually for 5mCG
        whicl 5mC, 4mC and 6mA would not be run.

#### Selecting which samples to run:
Once the pod5 files are in the designated folder (mentioned in config.yaml), the "exps" key (on line 5) can be used to control which samples to be run.
    eg: 
        pod5 folder strurture:
            .
            ├── Anabaena_WT_5kHz
            ├── Ecoli_DM_5kHz
            ├── Ecoli_DM_MSssI_5kHz
            ├── Ecoli_WT_5kHz
            ├── HP26695_WGA_5kHz
            ├── HP26695_WT_5kHz
            ├── HPJ99_WT_5kHz
            └── Tdenticola_WT_5kHz
        
        for this setup, to run all the samples, the exps value has to be populated like so:
            
            exps: [Anabaena_WT,Ecoli_DM, Ecoli_DM_MSssI, Ecoli_WT, HP26695_WGA, HP26695_WT, HPJ99_WT, Tdenticola_WT]

            These are the names of the pod5 folders excluding the '_5kHz' part.
            To limit the number of samples run, you can remove the values that you dont want to be processed from the list.

            exps: [Ecoli_DM, Ecoli_WT]
            here only Ecoli_DM and Ecoli_WT will be processed.


## Running the Snakemake workflow

```bash
    conda activate ont_basemod_benchmarking_env
    snakemake --use-conda -s snakemake_pipelines/snakefile --cores 40 
    ## cores can be set to the max that your machine supports
```
## final directory structure

The following is the directory structure generated by the snakemake workflow. Of which, those highlighted cyan are required by the workflow to start running while the others are generated by the workflow as it progresses through the pipeline.

<pre>
.
├── <span style="color: cyan">snakemake_pipelines</span> <span style="color: green"># snakemake workflow directory </span>
├── <span style="color: cyan">pod5</span>            <span style="color: green"># Default path to pod5 files</span>
├── bam             <span style="color: green"># basecalled mod/move_table bams</span>
├── modkit          <span style="color: green"># modkit output</span>
├── deepmod2        <span style="color: green"># deepmod2 output</span>
├── deepbam         <span style="color: green"># deepbam output</span>
├── deepplant       <span style="color: green"># deepplant output</span>
├── f5c             <span style="color: green"># f5c output</span>
├── rockfish        <span style="color: green"># rockfish output</span>
├── log             <span style="color: green"># log folder generated by workflow</span>
├── meta            <span style="color: green"># standardised bed output</span>
├── meta_context    <span style="color: green"># standardised bed output with C context</span>
├── qc              <span style="color: green"># qc folder</span>
├── <span style="color: cyan">references.yaml</span> <span style="color: green"># list of references to use</span>
└── <span style="color: cyan">config.yaml</span>     <span style="color: green"># snakemake config file</span>
</pre>